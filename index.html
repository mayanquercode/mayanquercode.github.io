<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventario de Productos (Supabase)</title>
    <script defer src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
      defer
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJdU44d7j0K7UaJ+q7h6g5A2c+qHwGgH2E6/oOQ4JqBw3q5vWnF+vN0FfA9Q=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      /* Estilos generales y contenedor móvil */
      body {
        background-color: #f0f4f8;
      }

      .app-container {
        max-width: 420px;
        min-height: 100vh;
        margin: 0 auto;
        background-color: #ffffff;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);
        position: relative;
      }

      /* CLASES DE ANIMACIÓN DEL MODAL */
      .modal-slide {
        transform: translateY(-100%);
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
      }

      .modal-slide.is-active {
        transform: translateY(0);
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <header class="p-4 bg-indigo-600 text-white shadow-lg sticky top-0 z-10">
        <h1 class="text-2xl font-extrabold text-center mb-3">Inventario Quininde</h1>

        <section class="w-full bg-neutral-primary-soft">
          <button
            id="open-search-modal"
            type="button"
            class="flex items-center w-full h-12 px-4 bg-gray-100 rounded-full border border-gray-200 shadow-sm text-left transition duration-150 ease-in-out hover:bg-gray-200 active:bg-gray-300"
          >
            <i
              class="fa-solid fa-magnifying-glass text-gray-500 pr-3 text-lg"
            ></i>
            <span class="text-gray-500 text-base font-normal">
              Buscar producto...
            </span>
          </button>
        </section>
      </header>

      <main class="p-4">
        <div id="product-detail-view" class="hidden">
          <button
            id="back-to-list"
            class="flex items-center text-indigo-600 mb-4 font-semibold hover:text-indigo-800 transition"
          >
            <i class="fa-solid fa-arrow-left mr-2"></i> Volver al inventario
          </button>
          <div
            id="detail-content"
            class="bg-white p-6 rounded-xl shadow-lg border border-gray-100"
          ></div>
        </div>

        <div id="list-view-container">
          <div id="loading-state" class="text-center p-8">
            <svg
              class="animate-spin h-8 w-8 text-indigo-500 mx-auto mb-3"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"
              ></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
            <p class="text-gray-600">Cargando productos...</p>
          </div>

          <div id="products-list" class="space-y-4"></div>

          <div id="empty-state" class="text-center p-10 hidden">
            <p class="text-xl font-semibold text-gray-500">
              No se encontraron productos.
            </p>
            <p class="text-gray-400">
              Verifica la conexión o si la tabla está vacía.
            </p>
          </div>

          <div
            id="error-state"
            class="text-center p-10 hidden bg-red-100 border-l-4 border-red-500 text-red-700"
          >
            <p class="font-bold">Error de Conexión</p>
            <p id="error-message"></p>
          </div>
        </div>
      </main>

      <div
        id="search-modal"
        class="fixed top-0 left-0 w-full h-full bg-white z-50 modal-slide pointer-events-none opacity-0"
      >
        <div class="h-full flex flex-col">
          <div class="flex items-center p-4 shadow-md bg-white">
            <input
              id="search-input"
              type="search"
              placeholder="Buscar producto por nombre o código..."
              class="flex-grow h-12 px-4 bg-gray-100 rounded-full border border-gray-200 shadow-sm text-base text-gray-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150 ease-in-out"
            />

            <button
              id="close-search-modal"
              class="p-2 ml-3 text-gray-500 hover:text-gray-800"
            >
              <i class="fa-solid fa-circle-xmark text-2xl"></i>
            </button>
          </div>

          <div class="flex-grow p-4 overflow-y-auto">
            <div id="search-results-list" class="space-y-3">
              <p
                class="text-center text-gray-400 mt-10"
                id="search-placeholder"
              >
                Comienza a escribir para buscar productos...
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // ----------------------------------------------------------------------
        // CONFIGURACIÓN DE SUPABASE
        // ----------------------------------------------------------------------
        const SUPABASE_URL = "https://doxfkasuczubrsxmaqne.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRveGZrYXN1Y3p1YnJzeG1hcW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNDg4MjgsImV4cCI6MjA4MDcyNDgyOH0.3YOc39BacxmpoI4IQ5gjm841U7qmwxZ8i7PksWmw8xU";
        const supabase = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY
        );

        // ----------------------------------------------------------------------
        // REFERENCIAS DOM Y ESTADO
        // ----------------------------------------------------------------------
        let currentSearchResults = []; // Para almacenar temporalmente los resultados de la búsqueda

        // Lista Principal
        const productsList = document.getElementById("products-list");
        const loadingState = document.getElementById("loading-state");
        const emptyState = document.getElementById("empty-state");
        const errorState = document.getElementById("error-state");
        const errorMessage = document.getElementById("error-message");
        const listViewContainer = document.getElementById(
          "list-view-container"
        );

        // Vista de Detalle (NUEVO)
        const detailView = document.getElementById("product-detail-view");
        const detailContent = document.getElementById("detail-content");
        const backToListBtn = document.getElementById("back-to-list");

        // Modal
        const openBtn = document.getElementById("open-search-modal");
        const closeBtn = document.getElementById("close-search-modal");
        const modal = document.getElementById("search-modal");
        const searchInput = document.getElementById("search-input");
        const searchResultsList = document.getElementById(
          "search-results-list"
        );
        const searchPlaceholder = document.getElementById("search-placeholder");

        // ----------------------------------------------------------------------
        // FUNCIONES DE RENDERIZADO
        // ----------------------------------------------------------------------

        /**
         * @description Crea el HTML para la tarjeta de un producto (usada en la lista principal y resultados).
         */
        function renderProductCard(product, isSearchContext = false) {
          let categoryColor = "bg-blue-100 text-blue-800";
          let unitColor = "bg-gray-200 text-gray-700";

          if (product.category === "Alimentos")
            categoryColor = "bg-green-100 text-green-800";

          const cardHTML = `
                    <div data-code="${product.code}" class="product-card ${
            isSearchContext
              ? "cursor-pointer hover:bg-indigo-50 active:bg-indigo-100"
              : ""
          } bg-white p-4 rounded-xl shadow-lg border border-gray-100">
                        <div class="flex items-start justify-between mb-2">
                            <h2 class="text-lg font-semibold text-gray-900 leading-snug">${
                              product.name
                            }</h2>
                            <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${unitColor}">
                                ${product.unit_type}
                            </span>
                        </div>
                        
                        <div class="space-y-1 text-sm">
                            <p class="flex justify-between text-gray-600">
                                <span class="font-medium">Código:</span>
                                <span class="font-mono text-indigo-700">${
                                  product.code
                                }</span>
                            </p>
                            
                            <p class="flex justify-between items-center">
                                <span class="font-medium text-gray-600">Categoría:</span>
                                <span class="inline-block px-2 py-0.5 text-xs font-medium rounded ${categoryColor}">
                                    ${product.category}
                                </span>
                            </p>
                        </div>
                    </div>
                `;
          return cardHTML;
        }

        /**
         * @description Crea el HTML para la vista de detalle (más expandida).
         */
        function renderProductDetail(product) {
          return `
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">${product.name}</h2>
                    
                    <div class="space-y-3">
                        <p class="text-base text-gray-700 border-b pb-2 flex justify-between items-center">
                            <span class="font-semibold text-indigo-600">Código:</span> 
                            <span class="font-mono text-xl">${product.code}</span>
                        </p>
                        
                        <p class="text-base text-gray-700 border-b pb-2 flex justify-between items-center">
                            <span class="font-semibold text-indigo-600">Categoría:</span> 
                            <span class="inline-block px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">${product.category}</span>
                        </p>
                        
                        <p class="text-base text-gray-700 border-b pb-2 flex justify-between items-center">
                            <span class="font-semibold text-indigo-600">Tipo de Unidad:</span> 
                            <span class="text-gray-900 font-semibold">${product.unit_type}</span>
                        </p>
                        
                        <p class="text-sm text-gray-500 pt-4 italic">
                            Información extendida sobre el producto seleccionado.
                        </p>
                    </div>
                `;
        }

        /**
         * @description Muestra los detalles del producto en la vista principal y cierra el modal.
         * @param {Object} product - Objeto completo del producto seleccionado.
         */
        function showProductDetail(product) {
          // 1. Renderizar el detalle
          detailContent.innerHTML = renderProductDetail(product);

          // 2. Cambiar la vista: Ocultar lista, mostrar detalle
          listViewContainer.classList.add("hidden");
          detailView.classList.remove("hidden");

          // 3. Cerrar el modal
          closeModal();

          // Desplazar al inicio de la página para ver el detalle
          window.scrollTo({ top: 0, behavior: "smooth" });
        }

        // ----------------------------------------------------------------------
        // LÓGICA DEL MODAL Y BÚSQUEDA
        // ----------------------------------------------------------------------

        function openModal() {
          modal.classList.add("is-active");
          modal.classList.remove("opacity-0", "pointer-events-none");
          searchInput.focus();
        }

        function closeModal() {
          modal.classList.remove("is-active");
          setTimeout(() => {
            modal.classList.add("opacity-0", "pointer-events-none");
          }, 300);
        }

        async function searchProducts(searchTerm) {
          const term = searchTerm.trim();
          searchResultsList.innerHTML = "";
          searchPlaceholder.classList.remove("hidden");

          if (term.length < 2) {
            searchPlaceholder.textContent =
              "Comienza a escribir para buscar productos...";
            return;
          }

          searchPlaceholder.textContent = "Buscando...";

          try {
            const { data, error } = await supabase
              .from("products")
              .select("code, name, category, unit_type")
              .or(`name.ilike.%${term}%,code.ilike.%${term}%`)
              .limit(10);

            if (error) throw error;

            searchPlaceholder.classList.add("hidden");
            currentSearchResults = data; // Almacenar resultados

            if (data.length === 0) {
              searchResultsList.innerHTML = `<p class="text-center text-gray-500 mt-10">No hay resultados para "${term}".</p>`;
            } else {
              data.forEach((product) => {
                searchResultsList.innerHTML += renderProductCard(product, true);
              });
              attachDetailListeners();
            }
          } catch (error) {
            searchPlaceholder.classList.remove("hidden");
            searchPlaceholder.textContent = `Error al buscar: ${error.message}`;
            console.error("Error en la búsqueda:", error);
          }
        }

        // ----------------------------------------------------------------------
        // LISTENERS DINÁMICOS
        // ----------------------------------------------------------------------

        function attachDetailListeners() {
          // Primero, limpia cualquier listener anterior (evita duplicados)
          document
            .querySelectorAll("#search-results-list .product-card")
            .forEach((card) => {
              const newCard = card.cloneNode(true);
              card.parentNode.replaceChild(newCard, card);
            });

          // Añade listeners a las tarjetas de resultados para mostrar detalle
          document
            .querySelectorAll("#search-results-list .product-card")
            .forEach((card) => {
              card.addEventListener("click", () => {
                const code = card.getAttribute("data-code");
                const selectedProduct = currentSearchResults.find(
                  (p) => p.code === code
                );
                if (selectedProduct) {
                  showProductDetail(selectedProduct); // Llama a la nueva función de detalle
                }
              });
            });
        }

        // ----------------------------------------------------------------------
        // EVENT LISTENERS FIJOS
        // ----------------------------------------------------------------------

        openBtn.addEventListener("click", openModal);
        closeBtn.addEventListener("click", closeModal);

        // Listener para volver a la vista de lista desde el detalle
        backToListBtn.addEventListener("click", () => {
          detailView.classList.add("hidden");
          listViewContainer.classList.remove("hidden");
        });

        // Búsqueda en tiempo real (con debounce)
        let searchTimeout;
        searchInput.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          const searchTerm = e.target.value;
          searchTimeout = setTimeout(() => {
            searchProducts(searchTerm);
          }, 300);
        });

        // ----------------------------------------------------------------------
        // CARGA INICIAL
        // ----------------------------------------------------------------------

        async function fetchProducts() {
          // ... (código de carga inicial)
          loadingState.classList.remove("hidden");
          productsList.innerHTML = "";
          emptyState.classList.add("hidden");
          errorState.classList.add("hidden");

          try {
            const { data, error } = await supabase
              .from("products")
              .select("*")
              .order("name", { ascending: true });

            if (error) throw error;

            loadingState.classList.add("hidden");

            if (data && data.length > 0) {
              data.forEach((product) => {
                productsList.innerHTML += renderProductCard(product, false);
              });
            } else {
              emptyState.classList.remove("hidden");
            }
          } catch (error) {
            loadingState.classList.add("hidden");
            errorState.classList.remove("hidden");
            errorMessage.textContent =
              error.message || "Verifica tu URL, clave o las políticas RLS.";
            console.error("Error al obtener datos de Supabase:", error);
          }
        }

        fetchProducts();
      });
    </script>
  </body>
</html>
